name: Workflow Test

on: [push]

env:
  HOST: "localhost"
  MYSQLUSER: "root"
  PASSWORD: "root"

jobs:
  push-action:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Hello Message
      run: echo "Hello, GitHub Actions!"

    - name: Starting Node JS message
      run: echo "Setting up Node JS"

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14

    - name: Finishing Node JS set up message
      run: echo "Node JS installation done"

    - name: Starting installation for mysql-server
      run: echo "Node JS installation done"

    - name: Show environment variables
      run: |
        echo "HOST=${HOST}"
        echo "MYSQLUSER=${MYSQLUSER}"
        echo "PASSWORD=${{ secrets.MY_GENERATED_PASSWORD }}"

    - name: Install MySQL and Set Password
      run: |
        echo "Installing MySQL server"
        sudo apt-get update
        sudo apt-get -y install mysql-server
        sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '${{ secrets.SQL_PASSWORD }}';"
        sudo mysql -e "FLUSH PRIVILEGES;" 


    - name: Wait for MySQL to start
      run: |
          until mysqladmin ping -h ${{ env.HOST }} -u ${{ env.MYSQLUSER }} -p${{ secrets.SQL_PASSWORD }}; do
            echo "Waiting for MySQL to start..."
            sleep 5
          done

    - name: Starting dependency installation
      run: echo "Installing Dependencies"

    - name: Install dependencies
      run: npm install

    - name: Dependency installation completed
      run: echo "Dependencies Installed"

    - name: Running test files
      run: echo "Starting test"

    - name: run tests
      run: npm test

    - name: Test files execution completion
      run: echo "Finished running test files"
